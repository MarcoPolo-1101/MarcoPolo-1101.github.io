<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marco Polo速查</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-theme {
                transition: background-color 0.3s, color 0.3s;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-4 py-2 rounded-lg hover:bg-secondary/90 transition-all;
            }
            .btn-danger {
                @apply bg-danger text-white px-4 py-2 rounded-lg hover:bg-danger/90 transition-all;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all dark:bg-gray-700 dark:border-gray-600 dark:text-white;
            }
            .badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-theme">
    <!-- 登录页面 -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-6 md:p-8">
                <div class="text-center mb-8">
                    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">Marco Polo速查</h1>
                    <p class="text-secondary dark:text-gray-400">产品管理系统</p>
                </div>
                
                <!-- 身份切换 -->
                <div class="flex mb-6 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-700">
                    <button id="user-tab" class="flex-1 py-2 px-4 text-center font-medium bg-primary text-white" onclick="switchAuth('user')">
                        普通用户
                    </button>
                    <button id="admin-tab" class="flex-1 py-2 px-4 text-center font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" onclick="switchAuth('admin')">
                        管理员
                    </button>
                </div>
                
                <!-- 登录表单 -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <input type="hidden" id="auth-type" value="user">
                    
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium mb-1 dark:text-gray-300">用户名</label>
                        <input type="text" id="username" class="input-field" placeholder="请输入用户名" required>
                    </div>
                    
                    <div class="mb-6 relative">
                        <label for="password" class="block text-sm font-medium mb-1 dark:text-gray-300">密码</label>
                        <input type="password" id="password" class="input-field pr-10" placeholder="请输入密码" required>
                        <button type="button" id="toggle-pwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword()">
                            <i class="fa fa-eye-slash"></i>
                        </button>
                    </div>
                    
                    <div id="login-error" class="mb-4 text-danger text-sm hidden">
                        <i class="fa fa-exclamation-circle mr-1"></i> 用户名或密码错误
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <i class="fa fa-sign-in mr-2"></i> 登录系统
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 主应用页面 (默认隐藏) -->
    <div id="app-page" class="hidden flex flex-col min-h-screen">
        <!-- 顶部导航栏 -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-theme">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-primary mr-4">Marco Polo速查</h1>
                    <span id="user-role" class="badge bg-primary/10 text-primary dark:bg-primary/20">
                        普通用户
                    </span>
                </div>
                
                <div class="flex items-center space-x-3 md:space-x-4">
                    <!-- 主题切换 -->
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="toggleTheme()">
                        <i class="fa fa-moon-o dark:hidden"></i>
                        <i class="fa fa-sun-o hidden dark:inline-block"></i>
                    </button>
                    
                    <!-- 设置按钮（管理员专属） -->
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="openSettings()" style="display: none;">
                        <i class="fa fa-cog"></i>
                    </button>
                    
                    <!-- 帮助按钮 -->
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="openHelp()">
                        <i class="fa fa-question-circle"></i>
                    </button>
                    
                    <!-- 退出登录 -->
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-danger" onclick="confirmAction('确定要退出登录吗？', handleLogout)">
                        <i class="fa fa-sign-out"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-1 container mx-auto px-4 py-6">
            <!-- 操作栏 (仅管理员可见) -->
            <div id="action-bar" class="mb-6 flex flex-wrap items-center justify-between gap-4" style="display: none;">
                <div class="flex flex-wrap gap-2">
                    <button class="btn-primary" onclick="openProductModal()">
                        <i class="fa fa-plus mr-1"></i> 添加产品
                    </button>
                    <button class="btn-secondary" onclick="importData()">
                        <i class="fa fa-upload mr-1"></i> 导入数据
                    </button>
                    <button class="btn-secondary" onclick="exportData()">
                        <i class="fa fa-download mr-1"></i> 导出数据
                    </button>
                </div>
                
                <!-- 视图切换 -->
                <div class="flex border rounded-lg overflow-hidden">
                    <button id="grid-view" class="px-3 py-1 bg-primary text-white" onclick="switchView('grid')">
                        <i class="fa fa-th-large"></i>
                    </button>
                    <button id="list-view" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="switchView('list')">
                        <i class="fa fa-list"></i>
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左侧筛选区 -->
                <div id="filter-panel" class="lg:w-1/4 bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                    <h2 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        <span>筛选条件</span>
                        <button class="text-sm text-secondary hover:text-primary transition-colors" onclick="resetFilters()">
                            重置
                        </button>
                    </h2>
                    
                    <!-- 产品系列筛选 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2 dark:text-gray-300">产品系列</label>
                        <div class="relative">
                            <select id="series-filter" class="input-field appearance-none pr-8">
                                <option value="">全部系列</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex items-center mt-2" id="series-add-container" style="display: none;">
                            <input type="text" id="new-series" class="input-field text-sm w-full mr-2" placeholder="添加新系列">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('series')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 尺寸规格筛选 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2 dark:text-gray-300">尺寸规格</label>
                        <div class="relative">
                            <select id="size-filter" class="input-field appearance-none pr-8">
                                <option value="">全部尺寸</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex items-center mt-2" id="size-add-container" style="display: none;">
                            <input type="text" id="new-size" class="input-field text-sm w-full mr-2" placeholder="添加新尺寸">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('size')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 价格范围筛选 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2 dark:text-gray-300">价格范围</label>
                        <div class="flex gap-2">
                            <input type="number" id="min-price" class="input-field text-sm" placeholder="最低">
                            <span class="self-center">-</span>
                            <input type="number" id="max-price" class="input-field text-sm" placeholder="最高">
                        </div>
                    </div>
                    
                    <!-- 产品状态筛选 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2 dark:text-gray-300">产品状态</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="onsale" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>在售</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discontinued" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>已停产</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="hot" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>爆款</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discount" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>特价</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 筛选按钮 -->
                    <button class="btn-primary w-full" onclick="applyFilters()">
                        <i class="fa fa-filter mr-1"></i> 应用筛选
                    </button>
                </div>

                <!-- 右侧内容区 (统计 + 产品列表) -->
                <div class="lg:w-3/4 flex flex-col gap-6">
                    <!-- 数据统计区 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">产品总数</p>
                                <p id="total-products" class="text-xl font-bold text-primary">0</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">在售产品</p>
                                <p id="onsale-products" class="text-xl font-bold text-success">0</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">已停产产品</p>
                                <p id="discontinued-products" class="text-xl font-bold text-danger">0</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">爆款产品</p>
                                <p id="hot-products" class="text-xl font-bold text-warning">0</p>
                            </div>
                        </div>
                        
                        <!-- 产品系列分布图表 -->
                        <div class="h-64">
                            <canvas id="series-chart"></canvas>
                        </div>
                    </div>

                    <!-- 排序栏 -->
                    <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <h2 class="text-lg font-semibold">产品列表</h2>
                        <div class="flex items-center">
                            <label class="text-sm mr-2 dark:text-gray-300">排序:</label>
                            <select id="sort-by" class="input-field text-sm w-auto" onchange="sortProducts()">
                                <option value="newest">最新添加</option>
                                <option value="price-asc">价格从低到高</option>
                                <option value="price-desc">价格从高到低</option>
                            </select>
                        </div>
                    </div>

                    <!-- 产品列表区 -->
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-10 text-secondary dark:text-gray-400">
                            <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                            <p>暂无产品数据</p>
                            <p id="empty-hint" class="text-sm mt-1 hidden">请添加产品或导入数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-white dark:bg-gray-800 py-4 mt-auto transition-theme">
            <div class="container mx-auto px-4 text-center text-sm text-secondary dark:text-gray-400">
                <p>Marco Polo速查 © 2025 产品管理系统</p>
            </div>
        </footer>
    </div>

    <!-- 产品编辑模态框 (仅管理员可见) -->
    <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 id="modal-title" class="text-lg font-bold">添加产品</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="closeProductModal()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)" class="p-4">
                <input type="hidden" id="product-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium mb-1 dark:text-gray-300">
                            产品名称 <span class="text-danger">*</span>
                        </label>
                        <input type="text" id="product-name" class="input-field" required>
                    </div>
                    <div>
                        <label for="product-series" class="block text-sm font-medium mb-1 dark:text-gray-300">
                            产品系列 <span class="text-danger">*</span>
                        </label>
                        <select id="product-series" class="input-field" required>
                            <option value="">选择系列</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-size" class="block text-sm font-medium mb-1 dark:text-gray-300">
                            尺寸规格 <span class="text-danger">*</span>
                        </label>
                        <select id="product-size" class="input-field" required>
                            <option value="">选择尺寸</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium mb-1 dark:text-gray-300">
                            产品价格 <span class="text-danger">*</span>
                        </label>
                        <input type="number" id="product-price" class="input-field" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="product-status" class="block text-sm font-medium mb-1 dark:text-gray-300">
                        产品状态 <span class="text-danger">*</span>
                    </label>
                    <select id="product-status" class="input-field" required>
                        <option value="onsale">在售</option>
                        <option value="discontinued">已停产</option>
                        <option value="hot">爆款</option>
                        <option value="discount">特价</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 dark:text-gray-300">产品图片</label>
                    <div class="flex items-center gap-4">
                        <div id="preview-container" class="w-24 h-24 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg flex items-center justify-center overflow-hidden bg-gray-50 dark:bg-gray-700">
                            <img id="image-preview" src="https://picsum.photos/200/200?random=1" alt="预览图" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="btn-secondary cursor-pointer text-center">
                                <i class="fa fa-upload mr-1"></i> 本地上传
                                <input type="file" id="image-upload" class="hidden" accept="image/*">
                            </label>
                            <button type="button" class="btn-secondary" onclick="takePhoto()">
                                <i class="fa fa-camera mr-1"></i> 拍照上传
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">取消</button>
                    <button type="submit" class="btn-primary">
                        <i class="fa fa-save mr-1"></i> 保存产品
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 设置模态框 (仅管理员可见) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-lg font-bold">系统设置</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="closeSettings()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- 主题设置 -->
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-3">主题设置</h3>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-primary" checked>
                            <span>浅色模式</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-primary">
                            <span>深色模式</span>
                        </label>
                    </div>
                </div>
                
                <!-- 用户密码管理 -->
                <div id="user-management" class="mb-6">
                    <h3 class="text-md font-semibold mb-3">用户密码管理</h3>
                    
                    <!-- 普通用户密码修改 -->
                    <div class="mb-5 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium mb-2">普通用户密码修改</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="user-password" class="block text-sm font-medium mb-1 dark:text-gray-300">新密码</label>
                                <div class="relative">
                                    <input type="password" id="user-password" class="input-field pr-10" placeholder="请输入新密码">
                                    <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('user-password')">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="user-password-confirm" class="block text-sm font-medium mb-1 dark:text-gray-300">确认密码</label>
                                <div class="relative">
                                    <input type="password" id="user-password-confirm" class="input-field pr-10" placeholder="请再次输入新密码">
                                    <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('user-password-confirm')">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p id="user-password-hint" class="text-xs text-secondary mt-1 hidden">
                            <i class="fa fa-info-circle mr-1"></i> 密码修改后将立即生效
                        </p>
                    </div>
                    
                    <!-- 管理员密码修改 -->
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-medium mb-2">管理员密码修改</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="admin-password" class="block text-sm font-medium mb-1 dark:text-gray-300">新密码</label>
                                <div class="relative">
                                    <input type="password" id="admin-password" class="input-field pr-10" placeholder="请输入新密码">
                                    <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('admin-password')">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="admin-password-confirm" class="block text-sm font-medium mb-1 dark:text-gray-300">确认密码</label>
                                <div class="relative">
                                    <input type="password" id="admin-password-confirm" class="input-field pr-10" placeholder="请再次输入新密码">
                                    <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('admin-password-confirm')">
                                        <i class="fa fa-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p id="admin-password-hint" class="text-xs text-secondary mt-1 hidden">
                            <i class="fa fa-exclamation-circle mr-1"></i> 请妥善保管管理员密码！
                        </p>
                    </div>
                    
                    <!-- 保存密码按钮 -->
                    <button class="btn-primary mt-3" onclick="savePasswords()">
                        <i class="fa fa-save mr-1"></i> 保存密码修改
                    </button>
                </div>
                
                <!-- 自定义选项管理 -->
                <div id="custom-options" class="mb-6">
                    <h3 class="text-md font-semibold mb-3">自定义选项管理</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1 dark:text-gray-300">产品系列</label>
                            <div id="series-list" class="max-h-32 overflow-y-auto space-y-1 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1 dark:text-gray-300">尺寸规格</label>
                            <div id="size-list" class="max-h-32 overflow-y-auto space-y-1 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <button class="btn-danger mt-3" onclick="confirmAction('确定要重置所有自定义选项吗？', resetCustomOptions)">
                        <i class="fa fa-refresh mr-1"></i> 重置为默认值
                    </button>
                </div>
                
                <!-- 数据管理 -->
                <div id="data-management" class="mb-6">
                    <h3 class="text-md font-semibold mb-3">数据管理</h3>
                    <div class="space-y-3">
                        <button class="btn-danger w-full" onclick="confirmAction('确定要清除所有产品数据吗？', clearAllData)">
                            <i class="fa fa-trash mr-1"></i> 清除产品数据
                        </button>
                        <button class="btn-secondary w-full" onclick="importDemoData()">
                            <i class="fa fa-download mr-1"></i> 导入演示数据
                        </button>
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm text-secondary">
                            <p>系统版本: v1.0.0</p>
                            <p>最后更新: 2025-01-01</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-lg font-bold">使用帮助</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="closeHelp()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div id="user-help" class="mb-4">
                    <h3 class="text-md font-semibold mb-2">普通用户功能</h3>
                    <ul class="list-disc pl-5 space-y-1 text-sm">
                        <li>查看产品列表及产品详情</li>
                        <li>使用筛选功能查找特定产品</li>
                        <li>切换产品列表视图（网格/列表）</li>
                        <li>按不同条件排序产品</li>
                        <li>切换系统主题（浅色/深色）</li>
                    </ul>
                </div>
                
                <div id="admin-help" class="mb-4 hidden">
                    <h3 class="text-md font-semibold mb-2">管理员额外功能</h3>
                    <ul class="list-disc pl-5 space-y-1 text-sm">
                        <li>添加、编辑、删除产品信息</li>
                        <li>导入/导出产品数据</li>
                        <li>管理产品系列和尺寸规格</li>
                        <li>修改用户密码</li>
                        <li>清除数据或导入演示数据</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md transition-theme">
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-lg font-bold">确认操作</h2>
            </div>
            <div class="p-6">
                <p id="confirm-message" class="mb-6">您确定要执行此操作吗？</p>
                <div class="flex justify-end gap-3">
                    <button class="btn-secondary" onclick="closeConfirm()">取消</button>
                    <button id="confirm-btn" class="btn-danger" onclick="executeConfirmAction()">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full hidden">
        <div class="flex items-center">
            <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = 'user'; // 当前用户类型: user/admin
        let currentView = 'grid'; // 当前视图: grid/list
        let products = []; // 产品数据
        let customSeries = ['基础款', '进阶款', '旗舰款']; // 自定义产品系列
        let customSizes = ['S', 'M', 'L', 'XL']; // 自定义尺寸规格
        let passwords = { user: '123', admin: '123' }; // 默认密码（管理员密码123）
        let confirmActionCallback = null; // 确认对话框回调函数
        let seriesChart = null; // 产品系列图表实例

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            checkLoginStatus();
            initChart();
            
            // 主题切换事件
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleTheme(this.value);
                });
            });
            
            // 图片上传预览
            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (currentUser !== 'admin') return;
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('image-preview').src = e.target.result;
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            updateFilterOptions();
            updateSettingsOptions();
            
            // 显示空数据提示（仅管理员可见）
            if (currentUser === 'admin' && products.length === 0) {
                document.getElementById('empty-hint').classList.remove('hidden');
            }
        });

        // 登录相关函数
        function switchAuth(type) {
            const userTab = document.getElementById('user-tab');
            const adminTab = document.getElementById('admin-tab');
            const authTypeInput = document.getElementById('auth-type');
            
            if (type === 'user') {
                userTab.classList.add('bg-primary', 'text-white');
                userTab.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                adminTab.classList.remove('bg-primary', 'text-white');
                adminTab.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                authTypeInput.value = 'user';
            } else {
                adminTab.classList.add('bg-primary', 'text-white');
                adminTab.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                userTab.classList.remove('bg-primary', 'text-white');
                userTab.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                authTypeInput.value = 'admin';
            }
            
            document.getElementById('login-error').classList.add('hidden');
        }

        function togglePassword(fieldId = 'password') {
            const passwordField = document.getElementById(fieldId);
            const toggleBtn = passwordField.nextElementSibling;
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleBtn.innerHTML = '<i class="fa fa-eye"></i>';
            } else {
                passwordField.type = 'password';
                toggleBtn.innerHTML = '<i class="fa fa-eye-slash"></i>';
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const authType = document.getElementById('auth-type').value;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorElement = document.getElementById('login-error');
            
            if (!username) {
                errorElement.textContent = '用户名不能为空';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password !== passwords[authType]) {
                errorElement.textContent = '用户名或密码错误';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // 登录成功处理 - 核心修复点：强制显示管理员功能
            currentUser = authType;
            localStorage.setItem('mp_currentUser', authType);
            localStorage.setItem('mp_username', username);
            
            // 切换页面
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
            
            // 更新用户角色显示
            const roleText = authType === 'user' ? '普通用户' : '管理员';
            document.getElementById('user-role').textContent = roleText;
            
            // 管理员权限：强制显示所有管理功能（直接操作style，避免CSS冲突）
            if (authType === 'admin') {
                // 强制显示设置按钮（齿轮图标）
                document.getElementById('settings-btn').style.display = 'block';
                // 显示操作栏
                document.getElementById('action-bar').style.display = 'flex';
                // 显示添加系列/尺寸的输入框
                document.getElementById('series-add-container').style.display = 'flex';
                document.getElementById('size-add-container').style.display = 'flex';
                // 显示设置页管理功能
                document.getElementById('user-management').style.display = 'block';
                document.getElementById('custom-options').style.display = 'block';
                document.getElementById('data-management').style.display = 'block';
                document.getElementById('admin-help').style.display = 'block';
            } else {
                // 普通用户隐藏所有管理员功能
                document.getElementById('settings-btn').style.display = 'none';
                document.getElementById('action-bar').style.display = 'none';
                document.getElementById('series-add-container').style.display = 'none';
                document.getElementById('size-add-container').style.display = 'none';
                document.getElementById('user-management').style.display = 'none';
                document.getElementById('custom-options').style.display = 'none';
                document.getElementById('data-management').style.display = 'none';
                document.getElementById('admin-help').style.display = 'none';
            }
            
            // 加载产品数据
            renderProducts();
            updateStatistics();
            showToast(`欢迎，${username}！`, 'success');
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('mp_currentUser');
            const savedUsername = localStorage.getItem('mp_username');
            
            if (savedUser && savedUsername) {
                currentUser = savedUser;
                
                // 切换到应用页面
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('app-page').classList.remove('hidden');
                
                // 更新用户角色显示
                const roleText = savedUser === 'user' ? '普通用户' : '管理员';
                document.getElementById('user-role').textContent = roleText;
                
                // 管理员权限：强制显示所有管理功能（直接操作style）
                if (savedUser === 'admin') {
                    document.getElementById('settings-btn').style.display = 'block';
                    document.getElementById('action-bar').style.display = 'flex';
                    document.getElementById('series-add-container').style.display = 'flex';
                    document.getElementById('size-add-container').style.display = 'flex';
                    document.getElementById('user-management').style.display = 'block';
                    document.getElementById('custom-options').style.display = 'block';
                    document.getElementById('data-management').style.display = 'block';
                    document.getElementById('admin-help').style.display = 'block';
                } else {
                    // 普通用户隐藏所有管理员功能
                    document.getElementById('settings-btn').style.display = 'none';
                    document.getElementById('action-bar').style.display = 'none';
                    document.getElementById('series-add-container').style.display = 'none';
                    document.getElementById('size-add-container').style.display = 'none';
                    document.getElementById('user-management').style.display = 'none';
                    document.getElementById('custom-options').style.display = 'none';
                    document.getElementById('data-management').style.display = 'none';
                    document.getElementById('admin-help').style.display = 'none';
                }
                
                renderProducts();
                updateStatistics();
            }
        }

        function handleLogout() {
            localStorage.removeItem('mp_currentUser');
            localStorage.removeItem('mp_username');
            
            document.getElementById('app-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
            switchAuth('user');
            
            currentUser = 'user';
        }

        // 主题切换
        function toggleTheme(theme = null) {
            const htmlElement = document.documentElement;
            let targetTheme = theme || (htmlElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            
            htmlElement.setAttribute('data-theme', targetTheme);
            document.querySelector(`input[name="theme"][value="${targetTheme}"]`).checked = true;
            
            // 更新图表主题
            if (seriesChart) {
                const textColor = targetTheme === 'dark' ? '#e2e8f0' : '#1e293b';
                seriesChart.options.scales.x.grid.color = targetTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                seriesChart.options.scales.y.grid.color = targetTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                seriesChart.options.scales.x.ticks.color = textColor;
                seriesChart.options.scales.y.ticks.color = textColor;
                seriesChart.update();
            }
        }

        // 产品管理相关函数
        function openProductModal(productId = null) {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const title = document.getElementById('modal-title');
            const productIdInput = document.getElementById('product-id');
            
            form.reset();
            productIdInput.value = '';
            document.getElementById('image-preview').src = 'https://picsum.photos/200/200?random=1';
            
            updateProductFormOptions();
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    title.textContent = '编辑产品';
                    productIdInput.value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-series').value = product.series;
                    document.getElementById('product-size').value = product.size;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-status').value = product.status;
                    document.getElementById('image-preview').src = product.image;
                }
            } else {
                title.textContent = '添加产品';
            }
            
            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function saveProduct(event) {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                event.preventDefault();
                return;
            }
            
            event.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            const series = document.getElementById('product-series').value;
            const size = document.getElementById('product-size').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const status = document.getElementById('product-status').value;
            const image = document.getElementById('image-preview').src;
            
            if (!name || !series || !size || isNaN(price)) {
                showToast('请填写完整的产品信息', 'error');
                return;
            }
            
            const productData = {
                name,
                series,
                size,
                price,
                status,
                image,
                createdAt: new Date().toISOString()
            };
            
            if (productId) {
                const index = products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    productData.id = productId;
                    products[index] = { ...products[index], ...productData };
                    showToast('产品编辑成功', 'success');
                }
            } else {
                productData.id = 'prod_' + Date.now();
                products.unshift(productData);
                showToast('产品添加成功', 'success');
            }
            
            saveDataToStorage();
            renderProducts();
            updateStatistics();
            closeProductModal();
        }

        function deleteProduct(productId) {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const index = products.findIndex(p => p.id === productId);
            if (index !== -1) {
                products.splice(index, 1);
                saveDataToStorage();
                renderProducts();
                updateStatistics();
                showToast('产品删除成功', 'success');
            }
        }

        function renderProducts(filteredProducts = null) {
            const productList = document.getElementById('product-list');
            const productsToRender = filteredProducts || [...products];
            
            productList.innerHTML = '';
            
            if (productsToRender.length === 0) {
                productList.innerHTML = `
                    <div class="col-span-full text-center py-10 text-secondary dark:text-gray-400">
                        <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                        <p>暂无符合条件的产品</p>
                        ${currentUser === 'admin' ? '<p class="text-sm mt-1">请添加产品或调整筛选条件</p>' : ''}
                    </div>
                `;
                return;
            }
            
            if (currentView === 'grid') {
                productsToRender.forEach(product => {
                    const statusClass = getStatusClass(product.status);
                    const statusText = getStatusText(product.status);
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow card-hover transition-theme';
                    card.innerHTML = `
                        <div class="h-48 overflow-hidden">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-lg truncate">${product.name}</h3>
                                <span class="badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="space-y-1 text-sm text-secondary dark:text-gray-400 mb-3">
                                <p><i class="fa fa-tags mr-1"></i> 系列: ${product.series}</p>
                                <p><i class="fa fa-expand mr-1"></i> 尺寸: ${product.size}</p>
                                <p><i class="fa fa-calendar mr-1"></i> 添加时间: ${formatDate(product.createdAt)}</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-primary font-bold">¥${product.price.toFixed(2)}</span>
                                ${currentUser === 'admin' ? `
                                    <div class="flex gap-2">
                                        <button class="text-primary hover:text-primary/80 transition-colors" 
                                            onclick="openProductModal('${product.id}')">
                                            <i class="fa fa-pencil"></i>
                                        </button>
                                        <button class="text-danger hover:text-danger/80 transition-colors" 
                                            onclick="confirmAction('确定要删除该产品吗？', () => deleteProduct('${product.id}'))">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    productList.appendChild(card);
                });
            } else {
                productsToRender.forEach(product => {
                    const statusClass = getStatusClass(product.status);
                    const statusText = getStatusText(product.status);
                    
                    const item = document.createElement('div');
                    item.className = 'bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-3 card-hover transition-theme';
                    item.innerHTML = `
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="md:w-1/4 h-24 overflow-hidden rounded-lg">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">
                            </div>
                            <div class="md:w-3/4 flex flex-col justify-between">
                                <div>
                                    <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                                        <h3 class="font-semibold text-lg">${product.name}</h3>
                                        <span class="badge ${statusClass}">${statusText}</span>
                                    </div>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-secondary dark:text-gray-400 mb-3">
                                        <p><i class="fa fa-tags mr-1"></i> 系列: ${product.series}</p>
                                        <p><i class="fa fa-expand mr-1"></i> 尺寸: ${product.size}</p>
                                        <p><i class="fa fa-calendar mr-1"></i> ${formatDate(product.createdAt)}</p>
                                        <p class="text-primary font-bold">¥${product.price.toFixed(2)}</p>
                                    </div>
                                </div>
                                ${currentUser === 'admin' ? `
                                    <div class="flex justify-end gap-2">
                                        <button class="btn-secondary px-3 py-1 text-sm" 
                                            onclick="openProductModal('${product.id}')">
                                            <i class="fa fa-pencil mr-1"></i> 编辑
                                        </button>
                                        <button class="btn-danger px-3 py-1 text-sm" 
                                            onclick="confirmAction('确定要删除该产品吗？', () => deleteProduct('${product.id}'))">
                                            <i class="fa fa-trash mr-1"></i> 删除
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    productList.appendChild(item);
                });
            }
        }

        // 筛选和排序相关函数
        function updateFilterOptions() {
            const seriesFilter = document.getElementById('series-filter');
            seriesFilter.innerHTML = '<option value="">全部系列</option>';
            customSeries.forEach(series => {
                const option = document.createElement('option');
                option.value = series;
                option.textContent = series;
                seriesFilter.appendChild(option);
            });
            
            const sizeFilter = document.getElementById('size-filter');
            sizeFilter.innerHTML = '<option value="">全部尺寸</option>';
            customSizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeFilter.appendChild(option);
            });
        }

        function updateProductFormOptions() {
            if (currentUser !== 'admin') return;
            
            const seriesSelect = document.getElementById('product-series');
            seriesSelect.innerHTML = '<option value="">选择系列</option>';
            customSeries.forEach(series => {
                const option = document.createElement('option');
                option.value = series;
                option.textContent = series;
                seriesSelect.appendChild(option);
            });
            
            const sizeSelect = document.getElementById('product-size');
            sizeSelect.innerHTML = '<option value="">选择尺寸</option>';
            customSizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
        }

        function addCustomOption(type) {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            if (type === 'series') {
                const newSeries = document.getElementById('new-series').value.trim();
                if (newSeries && !customSeries.includes(newSeries)) {
                    customSeries.push(newSeries);
                    document.getElementById('new-series').value = '';
                    updateFilterOptions();
                    updateProductFormOptions();
                    updateSettingsOptions();
                    saveDataToStorage();
                    showToast('产品系列添加成功', 'success');
                }
            } else if (type === 'size') {
                const newSize = document.getElementById('new-size').value.trim();
                if (newSize && !customSizes.includes(newSize)) {
                    customSizes.push(newSize);
                    document.getElementById('new-size').value = '';
                    updateFilterOptions();
                    updateProductFormOptions();
                    updateSettingsOptions();
                    saveDataToStorage();
                    showToast('尺寸规格添加成功', 'success');
                }
            }
        }

        function applyFilters() {
            const series = document.getElementById('series-filter').value;
            const size = document.getElementById('size-filter').value;
            const minPrice = document.getElementById('min-price').value ? parseFloat(document.getElementById('min-price').value) : null;
            const maxPrice = document.getElementById('max-price').value ? parseFloat(document.getElementById('max-price').value) : null;
            const statusCheckboxes = document.querySelectorAll(
                'input[type="checkbox"][value^="onsale"], input[type="checkbox"][value^="discontinued"],' +
                ' input[type="checkbox"][value^="hot"], input[type="checkbox"][value^="discount"]'
            );
            const selectedStatus = Array.from(statusCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            let filteredProducts = [...products];
            
            if (series) filteredProducts = filteredProducts.filter(p => p.series === series);
            if (size) filteredProducts = filteredProducts.filter(p => p.size === size);
            if (minPrice !== null) filteredProducts = filteredProducts.filter(p => p.price >= minPrice);
            if (maxPrice !== null) filteredProducts = filteredProducts.filter(p => p.price <= maxPrice);
            if (selectedStatus.length > 0) filteredProducts = filteredProducts.filter(p => selectedStatus.includes(p.status));
            
            filteredProducts = sortProductsData(filteredProducts);
            renderProducts(filteredProducts);
            updateStatistics(filteredProducts);
            showToast(`找到 ${filteredProducts.length} 个符合条件的产品`, 'success');
        }

        function resetFilters() {
            document.getElementById('series-filter').value = '';
            document.getElementById('size-filter').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            document.getElementById('new-series').value = '';
            document.getElementById('new-size').value = '';
            
            document.querySelectorAll(
                'input[type="checkbox"][value^="onsale"], input[type="checkbox"][value^="discontinued"],' +
                ' input[type="checkbox"][value^="hot"], input[type="checkbox"][value^="discount"]'
            ).forEach(cb => {
                cb.checked = true;
            });
            
            document.getElementById('sort-by').value = 'newest';
            renderProducts();
            updateStatistics();
            showToast('筛选条件已重置', 'success');
        }

        function switchView(viewType) {
            currentView = viewType;
            
            const gridBtn = document.getElementById('grid-view');
            const listBtn = document.getElementById('list-view');
            
            if (viewType === 'grid') {
                gridBtn.classList.add('bg-primary', 'text-white');
                gridBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                listBtn.classList.remove('bg-primary', 'text-white');
                listBtn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            } else {
                listBtn.classList.add('bg-primary', 'text-white');
                listBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                gridBtn.classList.remove('bg-primary', 'text-white');
                gridBtn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            }
            
            renderProducts();
        }

        function sortProducts() {
            const sortedProducts = sortProductsData([...products]);
            renderProducts(sortedProducts);
        }

        function sortProductsData(productsToSort) {
            const sortBy = document.getElementById('sort-by').value;
            
            switch (sortBy) {
                case 'newest':
                    return productsToSort.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                case 'price-asc':
                    return productsToSort.sort((a, b) => a.price - b.price);
                case 'price-desc':
                    return productsToSort.sort((a, b) => b.price - a.price);
                default:
                    return productsToSort;
            }
        }

        // 数据统计和图表相关函数
        function initChart() {
            const ctx = document.getElementById('series-chart').getContext('2d');
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDarkMode ? '#e2e8f0' : '#1e293b';
            
            seriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '产品数量',
                        data: [],
                        backgroundColor: [
                            'rgba(37, 99, 235, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(99, 102, 241, 0.7)'
                        ],
                        borderColor: [
                            'rgba(37, 99, 235, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(99, 102, 241, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: textColor, precision: 0 }
                        },
                        x: {
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            
            updateChartData();
        }

        function updateStatistics(filteredProducts = null) {
            const productsToCount = filteredProducts || [...products];
            
            const total = productsToCount.length;
            const onsale = productsToCount.filter(p => p.status === 'onsale').length;
            const discontinued = productsToCount.filter(p => p.status === 'discontinued').length;
            const hot = productsToCount.filter(p => p.status === 'hot').length;
            
            document.getElementById('total-products').textContent = total;
            document.getElementById('onsale-products').textContent = onsale;
            document.getElementById('discontinued-products').textContent = discontinued;
            document.getElementById('hot-products').textContent = hot;
            
            updateChartData(productsToCount);
        }

        function updateChartData(filteredProducts = null) {
            if (!seriesChart) return;
            
            const productsToCount = filteredProducts || [...products];
            const seriesCount = {};
            
            customSeries.forEach(series => {
                seriesCount[series] = 0;
            });
            
            productsToCount.forEach(product => {
                if (seriesCount.hasOwnProperty(product.series)) {
                    seriesCount[product.series]++;
                } else {
                    seriesCount[product.series] = 1;
                }
            });
            
            seriesChart.data.labels = Object.keys(seriesCount);
            seriesChart.data.datasets[0].data = Object.values(seriesCount);
            seriesChart.update();
        }

        // 设置相关函数 - 核心修复：确保设置模态框能正常打开
        function openSettings() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            // 强制显示设置模态框
            document.getElementById('settings-modal').classList.remove('hidden');
            updateSettingsOptions();
            
            document.getElementById('user-password').value = '';
            document.getElementById('user-password-confirm').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-password-confirm').value = '';
            
            document.getElementById('user-password-hint').classList.add('hidden');
            document.getElementById('admin-password-hint').classList.add('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function updateSettingsOptions() {
            if (currentUser !== 'admin') return;
            
            // 更新产品系列列表
            const seriesList = document.getElementById('series-list');
            seriesList.innerHTML = '';
            customSeries.forEach(series => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center';
                item.innerHTML = `
                    <span>${series}</span>
                    <button class="text-danger text-sm hover:text-danger/80"
                        onclick="confirmAction('确定要删除 ${series} 吗？', () => removeCustomOption('series', '${series}'))">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                seriesList.appendChild(item);
            });
            
            // 更新尺寸规格列表
            const sizeList = document.getElementById('size-list');
            sizeList.innerHTML = '';
            customSizes.forEach(size => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center';
                item.innerHTML = `
                    <span>${size}</span>
                    <button class="text-danger text-sm hover:text-danger/80"
                        onclick="confirmAction('确定要删除 ${size} 吗？', () => removeCustomOption('size', '${size}'))">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                sizeList.appendChild(item);
            });
        }

        // 密码修改功能
        function savePasswords() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const userPwd = document.getElementById('user-password').value.trim();
            const userPwdConfirm = document.getElementById('user-password-confirm').value.trim();
            const adminPwd = document.getElementById('admin-password').value.trim();
            const adminPwdConfirm = document.getElementById('admin-password-confirm').value.trim();
            
            document.getElementById('user-password-hint').classList.add('hidden');
            document.getElementById('admin-password-hint').classList.add('hidden');
            
            if (userPwd && userPwd !== userPwdConfirm) {
                showToast('普通用户两次输入的密码不一致', 'error');
                return;
            }
            
            if (adminPwd && adminPwd !== adminPwdConfirm) {
                showToast('管理员两次输入的密码不一致', 'error');
                return;
            }
            
            if (userPwd && userPwd.length < 3) {
                showToast('普通用户密码长度不能少于3位', 'error');
                return;
            }
            
            if (adminPwd && adminPwd.length < 3) {
                showToast('管理员密码长度不能少于3位', 'error');
                return;
            }
            
            let isUpdated = false;
            if (userPwd) {
                passwords.user = userPwd;
                isUpdated = true;
            }
            
            if (adminPwd) {
                passwords.admin = adminPwd;
                isUpdated = true;
            }
            
            if (!isUpdated) {
                showToast('请输入新密码进行修改', 'error');
                return;
            }
            
            saveDataToStorage();
            document.getElementById('user-password').value = '';
            document.getElementById('user-password-confirm').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-password-confirm').value = '';
            
            showToast('密码修改成功', 'success');
        }

        // 辅助函数
        function getStatusClass(status) {
            switch(status) {
                case 'onsale': return 'bg-success/10 text-success';
                case 'discontinued': return 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                case 'hot': return 'bg-warning/10 text-warning';
                case 'discount': return 'bg-danger/10 text-danger';
                default: return 'bg-gray-100 text-gray-600';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'onsale': return '在售';
                case 'discontinued': return '已停产';
                case 'hot': return '爆款';
                case 'discount': return '特价';
                default: return '未知';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-message');
            
            text.textContent = message;
            
            if (type === 'success') {
                icon.className = 'fa fa-check-circle mr-2 text-success';
            } else if (type === 'error') {
                icon.className = 'fa fa-exclamation-circle mr-2 text-danger';
            }
            
            toast.classList.remove('translate-x-full', 'hidden');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // 数据存储相关函数
        function loadDataFromStorage() {
            const savedProducts = localStorage.getItem('mp_products');
            const savedSeries = localStorage.getItem('mp_series');
            const savedSizes = localStorage.getItem('mp_sizes');
            const savedPasswords = localStorage.getItem('mp_passwords');
            
            if (savedProducts) products = JSON.parse(savedProducts);
            if (savedSeries) customSeries = JSON.parse(savedSeries);
            if (savedSizes) customSizes = JSON.parse(savedSizes);
            if (savedPasswords) passwords = JSON.parse(savedPasswords);
        }

        function saveDataToStorage() {
            if (currentUser !== 'admin') return;
            
            localStorage.setItem('mp_products', JSON.stringify(products));
            localStorage.setItem('mp_series', JSON.stringify(customSeries));
            localStorage.setItem('mp_sizes', JSON.stringify(customSizes));
            localStorage.setItem('mp_passwords', JSON.stringify(passwords));
        }

        // 确认对话框相关函数
        function confirmAction(message, callback) {
            if (currentUser !== 'admin' && callback.name !== 'handleLogout') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const modal = document.getElementById('confirm-modal');
            const messageEl = document.getElementById('confirm-message');
            
            messageEl.textContent = message;
            confirmActionCallback = callback;
            modal.classList.remove('hidden');
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmActionCallback = null;
        }

        function executeConfirmAction() {
            if (typeof confirmActionCallback === 'function') {
                confirmActionCallback();
            }
            closeConfirm();
        }

        // 其他功能函数
        function removeCustomOption(type, value) {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            if (type === 'series') {
                const index = customSeries.indexOf(value);
                if (index !== -1) customSeries.splice(index, 1);
            } else if (type === 'size') {
                const index = customSizes.indexOf(value);
                if (index !== -1) customSizes.splice(index, 1);
            }
            
            updateFilterOptions();
            updateProductFormOptions();
            updateSettingsOptions();
            saveDataToStorage();
            showToast('选项已删除', 'success');
        }

        function resetCustomOptions() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            customSeries = ['基础款', '进阶款', '旗舰款'];
            customSizes = ['S', 'M', 'L', 'XL'];
            
            updateFilterOptions();
            updateProductFormOptions();
            updateSettingsOptions();
            saveDataToStorage();
            showToast('自定义选项已重置为默认值', 'success');
        }

        function clearAllData() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            products = [];
            saveDataToStorage();
            renderProducts();
            updateStatistics();
            showToast('所有产品数据已清除', 'success');
        }

        function importDemoData() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const demoData = [
                {
                    id: 'prod_' + Date.now() - 10000,
                    name: '经典款T恤',
                    series: '基础款',
                    size: 'M',
                    price: 99.99,
                    status: 'onsale',
                    image: 'https://picsum.photos/400/300?random=10',
                    createdAt: new Date(Date.now() - 86400000 * 5).toISOString()
                },
                {
                    id: 'prod_' + Date.now() - 20000,
                    name: '高级运动裤',
                    series: '进阶款',
                    size: 'L',
                    price: 199.99,
                    status: 'hot',
                    image: 'https://picsum.photos/400/300?random=11',
                    createdAt: new Date(Date.now() - 86400000 * 3).toISOString()
                }
            ];
            
            products = [...demoData, ...products];
            saveDataToStorage();
            renderProducts();
            updateStatistics();
            showToast('演示数据导入成功', 'success');
        }

        function openHelp() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function closeHelp() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        function takePhoto() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            showToast('拍照功能暂未实现', 'error');
        }

        function importData() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            showToast('数据导入功能暂未实现', 'error');
        }

        function exportData() {
            if (currentUser !== 'admin') {
                showToast('没有权限执行此操作', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(products, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `marcopolo_products_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('数据导出成功', 'success');
        }
    </script>
</body>
</html>
