<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marco Polo速查</title>
    <!-- 替换Tailwind CSS CDN为更稳定的版本 -->
    <script src="https://cdn.tailwindcss.com?v=3.4.1"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-theme {
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all active:scale-95;
            }
            .btn-secondary {
                @apply bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all active:scale-95;
            }
            .btn-danger {
                @apply bg-danger text-white px-4 py-2 rounded-lg hover:bg-danger/90 transition-all active:scale-95;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition transition-all dark:bg-gray-700 dark:text-white outline-none;
            }
            .badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
            .form-label {
                @apply block text-sm font-medium mb-1.5 dark:text-gray-300;
            }
            .upload-area {
                @apply border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 transition-all hover:border-primary/50 dark:hover:border-primary/50;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-theme">
    <!-- 登录页面 -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <!-- 保持原有登录页面内容 -->
        <div class="w-full max-w-md">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 transition-theme">
                <div class="text-center mb-8">
                    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">Marco Polo速查</h1>
                    <p class="text-secondary dark:text-gray-400">产品管理系统</p>
                </div>
                
                <!-- 身份切换 -->
                <div class="flex mb-6 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-700">
                    <button id="user-tab" class="flex-1 py-2 px-4 text-center font-medium bg-primary text-white transition-all" onclick="switchAuth('user')">
                        普通用户
                    </button>
                    <button id="admin-tab" class="flex-1 py-2 px-4 text-center font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" onclick="switchAuth('admin')">
                        管理员
                    </button>
                </div>
                
                <!-- 登录表单 -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <input type="hidden" id="auth-type" value="user">
                    
                    <div class="mb-4.5">
                        <label for="email" class="form-label">邮箱</label>
                        <input type="email" id="email" class="input-field" placeholder="请输入邮箱" required>
                    </div>
                    
                    <div class="mb-6 relative">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" id="password" class="input-field pr-10" placeholder="请输入密码" required>
                        <button type="button" id="toggle-pwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('password')">
                            <i class="fa fa-eye-slash"></i>
                        </button>
                    </div>
                    
                    <div id="login-error" class="mb-4 text-danger text-sm hidden">
                        <i class="fa fa-exclamation-circle mr-1"></i> 邮箱或密码错误
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <i class="fa fa-sign-in mr-2"></i> 登录系统
                    </button>
                </form>

                <div class="mt-4 text-center text-xs text-secondary">
                    <p>普通用户默认邮箱: user@example.com | 管理员默认邮箱: admin@example.com</p>
                    <p class="mt-1">默认密码均为: password123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主应用页面 (默认隐藏) -->
    <div id="app-page" class="hidden flex flex-col min-h-screen">
        <!-- 顶部导航栏 -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-theme">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-primary mr-4">Marco Polo速查</h1>
                    <span id="user-role" class="badge bg-primary/10 text-primary dark:bg-primary/20">
                        普通用户
                    </span>
                </div>
                
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="toggleTheme()">
                        <i class="fa fa-moon-o dark:hidden"></i>
                        <i class="fa fa-sun-o hidden dark:inline-block"></i>
                    </button>
                    
                    <!-- 设置按钮 -->
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors hidden" onclick="openSettings()">
                        <i class="fa fa-cog"></i>
                    </button>
                    
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="openHelp()">
                        <i class="fa fa-question-circle"></i>
                    </button>
                    
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-danger" onclick="confirmAction('确定要退出登录吗？', handleLogout)">
                        <i class="fa fa-sign-out"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 - 保持原有内容 -->
        <main class="flex-1 container mx-auto px-4 py-6">
            <div id="action-bar" class="mb-6 flex flex-wrap items-center justify-between gap-4" style="display: none;">
                <div class="flex flex-wrap gap-2">
                    <button class="btn-primary" onclick="openProductModal()">
                        <i class="fa fa-plus mr-1"></i> 添加产品
                    </button>
                    <button class="btn-secondary" onclick="importData()">
                        <i class="fa fa-upload mr-1"></i> 导入数据
                    </button>
                    <button class="btn-secondary" onclick="exportData()">
                        <i class="fa fa-download mr-1"></i> 导出数据
                    </button>
                </div>
                
                <div class="flex border rounded-lg overflow-hidden">
                    <button id="grid-view" class="px-3 py-1.5 bg-primary text-white" onclick="switchView('grid')">
                        <i class="fa fa-th-large"></i>
                    </button>
                    <button id="list-view" class="px-3 py-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="switchView('list')">
                        <i class="fa fa-list"></i>
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左侧筛选区 -->
                <div id="filter-panel" class="lg:w-1/4 bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                    <h2 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        <span>筛选条件</span>
                        <button class="text-sm text-secondary hover:text-primary transition-colors" onclick="resetFilters()">
                            重置
                        </button>
                    </h2>
                    
                    <div class="mb-4.5">
                        <label class="form-label">产品系列</label>
                        <div class="relative">
                            <select id="series-filter" class="input-field appearance-none pr-8">
                                <option value="">全部系列</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex items-center mt-2" id="series-add-container" style="display: none;">
                            <input type="text" id="new-series" class="input-field text-sm w-full mr-2" placeholder="添加新系列">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('series')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4.5">
                        <label class="form-label">尺寸规格</label>
                        <div class="relative">
                            <select id="size-filter" class="input-field appearance-none pr-8">
                                <option value="">全部尺寸</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex items-center mt-2" id="size-add-container" style="display: none;">
                            <input type="text" id="new-size" class="input-field text-sm w-full mr-2" placeholder="添加新尺寸">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('size')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4.5">
                        <label class="form-label">价格范围</label>
                        <div class="flex gap-2">
                            <input type="number" id="min-price" class="input-field text-sm" placeholder="最低" step="0.01">
                            <span class="self-center">-</span>
                            <input type="number" id="max-price" class="input-field text-sm" placeholder="最高" step="0.01">
                        </div>
                    </div>
                    
                    <div class="mb-4.5">
                        <label class="form-label">产品状态</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="onsale" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>在售</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discontinued" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>已停产</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="hot" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>爆款</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discount" class="form-checkbox h-4 w-4 text-primary rounded" checked>
                                <span>特价</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn-primary w-full" onclick="applyFilters()">
                        <i class="fa fa-filter mr-1"></i> 应用筛选
                    </button>
                </div>

                <!-- 右侧内容区 -->
                <div class="lg:w-3/4 flex flex-col gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">产品总数</p>
                                <p id="total-products" class="text-xl font-bold text-primary">0</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">在售产品</p>
                                <p id="onsale-products" class="text-xl font-bold text-success">0</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">已停产产品</p>
                                <p id="discontinued-products" class="text-xl font-bold text-danger">0</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">爆款产品</p>
                                <p id="hot-products" class="text-xl font-bold text-warning">0</p>
                            </div>
                        </div>
                        
                        <div class="h-64">
                            <canvas id="series-chart"></canvas>
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <h2 class="text-lg font-semibold">产品列表</h2>
                        <div class="flex items-center">
                            <label class="text-sm mr-2 dark:text-gray-300">排序:</label>
                            <select id="sort-by" class="input-field text-sm w-auto" onchange="sortProducts()">
                                <option value="newest">最新添加</option>
                                <option value="price-asc">价格从低到高</option>
                                <option value="price-desc">价格从高到低</option>
                            </select>
                        </div>
                    </div>

                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-10 text-secondary dark:text-gray-400">
                            <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                            <p>暂无产品数据</p>
                            <p id="empty-hint" class="text-sm mt-1 hidden">请添加产品或导入数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-white dark:bg-gray-800 py-4 mt-auto transition-theme">
            <div class="container mx-auto px-4 text-center text-sm text-secondary dark:text-gray-400">
                <p>Marco Polo速查 © 2025 产品管理系统</p>
            </div>
        </footer>
    </div>

    <!-- 产品编辑模态框、设置模态框等其他模态框保持不变 -->
    <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <!-- 保持原有内容 -->
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <!-- 保持原有内容 -->
    </div>

    <div id="option-edit-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <!-- 保持原有内容 -->
    </div>

    <div id="help-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <!-- 保持原有内容 -->
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <!-- 保持原有内容 -->
    </div>

    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full hidden">
        <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        // 全局变量初始化
        let products = [];
        let customSeries = [];
        let customSizes = [];
        let currentUser = '';
        let dataSyncListener = null;
        let seriesChart = null;
        let currentImageFile = null;
        let currentImageUrl = '';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        
        // Supabase配置
        const supabaseUrl = 'https://hwkrjjewspcrorlwtdfr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3a3JqamV3c3Bjcm9ybHd0ZGZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTIyODUsImV4cCI6MjA3NzMyODI4NX0.O8-Y3AKhorxiXEdYGkT0ISAJkEQhUYITKyGhF9U34_w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 页面加载初始化 - 修改为更安全的DOMContentLoaded事件
        document.addEventListener('DOMContentLoaded', async function() {
            // 主题初始化
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // 检查登录状态
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user.email === 'admin@example.com' ? 'admin' : 'user';
                    await loadCustomOptions();
                    await loadProducts();
                    setupDataSync();
                    showAppPage(); // 确保DOM加载完成后再调用
                } else {
                    document.getElementById('login-page').classList.remove('hidden');
                    // 初始化登录页，默认选中普通用户并填充邮箱
                    switchAuth('user');
                }
            } catch (error) {
                console.error('初始化错误:', error);
                showToast('系统初始化失败，请刷新页面重试', 'error');
            }
        });

        // 核心修复：改进showAppPage函数，添加安全检查
        function showAppPage() {
            // 确保所有DOM元素存在再操作
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');
            const userRole = document.getElementById('user-role');
            const settingsBtn = document.getElementById('settings-btn');
            const actionBar = document.getElementById('action-bar');
            const seriesAddContainer = document.getElementById('series-add-container');
            const sizeAddContainer = document.getElementById('size-add-container');
            const emptyHint = document.getElementById('empty-hint');

            // 检查必要元素是否存在
            if (!loginPage || !appPage || !userRole) {
                console.error('关键DOM元素缺失');
                showToast('页面加载不完整，请刷新重试', 'error');
                return;
            }

            // 切换页面显示
            loginPage.classList.add('hidden');
            appPage.classList.remove('hidden');
            userRole.textContent = currentUser === 'admin' ? '管理员' : '普通用户';
            
            // 管理员权限元素处理
            if (currentUser === 'admin') {
                if (actionBar) actionBar.style.display = 'flex';
                if (settingsBtn) settingsBtn.classList.remove('hidden');
                if (seriesAddContainer) seriesAddContainer.style.display = 'flex';
                if (sizeAddContainer) sizeAddContainer.style.display = 'flex';
                if (emptyHint) emptyHint.classList.remove('hidden');
            } else {
                if (settingsBtn) settingsBtn.classList.add('hidden');
            }
        }

        // 其他函数保持不变，但添加错误处理
        function switchAuth(type) {
            try {
                const userTab = document.getElementById('user-tab');
                const adminTab = document.getElementById('admin-tab');
                const emailInput = document.getElementById('email');
                const authTypeInput = document.getElementById('auth-type');

                if (!userTab || !adminTab || !emailInput || !authTypeInput) {
                    throw new Error('切换身份所需元素缺失');
                }

                // 重置两个按钮的样式
                [userTab, adminTab].forEach(tab => {
                    tab.classList.remove('bg-primary', 'text-white');
                    tab.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                });

                // 设置选中状态
                if (type === 'user') {
                    userTab.classList.add('bg-primary', 'text-white');
                    userTab.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                    emailInput.value = 'user@example.com';
                } else {
                    adminTab.classList.add('bg-primary', 'text-white');
                    adminTab.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                    emailInput.value = 'admin@example.com';
                }
                
                authTypeInput.value = type;
                // 重置登录错误提示
                const loginError = document.getElementById('login-error');
                if (loginError) loginError.classList.add('hidden');
            } catch (error) {
                console.error('switchAuth错误:', error);
            }
        }

        // 打开设置模态框 - 添加安全检查
        function openSettings() {
            try {
                const settingsModal = document.getElementById('settings-modal');
                if (!settingsModal) {
                    throw new Error('设置模态框元素不存在');
                }
                settingsModal.classList.remove('hidden');
            } catch (error) {
                console.error('打开设置失败:', error);
                showToast('设置功能加载失败', 'error');
            }
        }

        // 其他函数保持原有逻辑，但建议在关键操作前添加元素存在性检查
        // ... (省略其他保持不变的函数)
    </script>
</body>
</html>
