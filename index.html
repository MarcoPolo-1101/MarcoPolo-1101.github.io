<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <!-- 新增：资源预加载优化 -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js" as="script">
    <!-- 新增：密码加密依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marco Polo速查</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-theme {
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-all active:scale-95;
            }
            .btn-secondary {
                @apply bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all active:scale-95;
            }
            .btn-danger {
                @apply bg-danger text-white px-4 py-2 rounded-lg hover:bg-danger/90 transition-all active:scale-95;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition                transition-all dark:bg-gray-700 dark:text-white outline-none;
            }
            .badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
            .form-label {
                @apply block text-sm font-medium mb-1.5 dark:text-gray-300;
            }
            .upload-area {
                @apply border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 transition-all hover:border-primary/50 dark:hover:border-primary/50;
            }
            /* 新增：加载动画样式 */
            .loader {
                border-top-color: #2563eb;
                animation: spinner 0.6s linear infinite;
            }
            @keyframes spinner {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-theme">
    <!-- 新增：加载动画容器 -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/80 dark:bg-gray-900/80 z-40 flex items-center justify-center hidden">
        <div class="loader rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
    </div>

    <!-- 登录页面 -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 transition-theme">
                <div class="text-center mb-8">
                    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">Marco Polo速查</h1>
                    <p class="text-secondary dark:text-gray-400">产品管理系统</p>
                </div>
                
                <!-- 身份切换 -->
                <div class="flex mb-6 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-700">
                    <button id="user-tab" class="flex-1 py-2 px-4 text-center font-medium bg-primary text-white transition-all" onclick="switchAuth('user')">
                        普通用户
                    </button>
                    <button id="admin-tab" class="flex-1 py-2 px-4 text-center font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" onclick="switchAuth('admin')">
                        管理员
                    </button>
                </div>
                
                <!-- 登录表单 -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <input type="hidden" id="auth-type" value="user">
                    
                    <div class="mb-4.5">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" id="username" class="input-field" placeholder="请输入用户名" required>
                    </div>
                    
                    <div class="mb-6 relative">
                        <label for="password" class="form-label">密码</label>
                        <input type="password" id="password" class="input-field pr-10" placeholder="请输入密码" required>
                        <button type="button" id="toggle-pwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('password')">
                            <i class="fa fa-eye-slash"></i>
                        </button>
                    </div>
                    
                    <div id="login-error" class="mb-4 text-danger text-sm hidden">
                        <i class="fa fa-exclamation-circle mr-1"></i> 用户名或密码错误
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">
                        <i class="fa fa-sign-in mr-2"></i> 登录系统
                    </button>
                </form>

                <!-- 登录帮助信息 -->
                <div class="mt-4 text-center text-xs text-secondary">
                </div>
            </div>
        </div>
    </div>

    <!-- 主应用页面 (默认隐藏) -->
    <div id="app-page" class="hidden flex flex-col min-h-screen">
        <!-- 顶部导航栏 -->
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-theme">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-primary mr-4">Marco Polo速查</h1>
                    <span id="user-role" class="badge bg-primary/10 text-primary dark:bg-primary/20">
                        普通用户
                    </span>
                </div>
                
                <div class="flex items-center space-x-3 md:space-x-4">
                    <!-- 主题切换 -->
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="toggleTheme()">
                        <i class="fa fa-moon-o dark:hidden"></i>
                        <i class="fa fa-sun-o hidden dark:inline-block"></i>
                    </button>
                    
                    <!-- 设置按钮（管理员专属） -->
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="openSettings()" style="display: none;">
                        <i class="fa fa-cog"></i>
                    </button>
                    
                    <!-- 帮助按钮 -->
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="openHelp()">
                        <i class="fa fa-question-circle"></i>
                    </button>
                    
                    <!-- 退出登录 -->
                    <button class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-danger" onclick="confirmAction('确定要退出登录吗？', handleLogout)">
                        <i class="fa fa-sign-out"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-1 container mx-auto px-4 py-6">
            <!-- 操作栏 (仅管理员可见) -->
            <div id="action-bar" class="mb-6 flex flex-wrap items-center justify-between gap-4" style="display: none;">
                <div class="flex flex-wrap gap-2">
                    <button class="btn-primary" onclick="openProductModal()">
                        <i class="fa fa-plus mr-1"></i> 添加产品
                    </button>
                    <button class="btn-secondary" onclick="importData()">
                        <i class="fa fa-upload mr-1"></i> 导入数据
                    </button>
                    <button class="btn-secondary" onclick="exportData()">
                        <i class="fa fa-download mr-1"></i> 导出数据
                    </button>
                </div>
                
                <!-- 视图切换 -->
                <div class="flex border rounded-lg overflow-hidden">
                    <button id="grid-view" class="px-3 py-1.5 bg-primary text-white" onclick="switchView('grid')">
                        <i class="fa fa-th-large"></i>
                    </button>
                    <button id="list-view" class="px-3 py-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="switchView('list')">
                        <i class="fa fa-list"></i>
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 左侧筛选区 -->
                <div id="filter-panel" class="lg:w-1/4 bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                    <h2 class="text-lg font-semibold mb-4 flex items-center justify-between">
                        <span>筛选条件</span>
                        <button class="text-sm text-secondary hover:text-primary transition-colors" onclick="resetFilters()">
                            重置
                        </button>
                    </h2>
                    
                    <!-- 产品系列筛选 - 新增编辑按钮 -->
                    <div class="mb-4.5">
                        <label class="form-label">产品系列</label>
                        <div class="relative">
                            <select id="series-filter" class="input-field appearance-none pr-8" onchange="debouncedApplyFilters()">
                                <option value="">全部系列</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                            <!-- 新增：编辑按钮 -->
                            <button type="button" class="absolute right-10 top-1/2 -translate-y-1/2 text-primary hover:text-primary/80 transition-colors" onclick="editCustomOption('series')">
                                <i class="fa fa-pencil"></i>
                            </button>
                        </div>
                        <div class="flex items-center mt-2" id="series-add-container" style="display: none;">
                            <input type="text" id="new-series" class="input-field text-sm w-full mr-2" placeholder="添加新系列">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('series')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 尺寸规格筛选 - 新增编辑按钮 -->
                    <div class="mb-4.5">
                        <label class="form-label">尺寸规格</label>
                        <div class="relative">
                            <select id="size-filter" class="input-field appearance-none pr-8" onchange="debouncedApplyFilters()">
                                <option value="">全部尺寸</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                            <!-- 新增：编辑按钮 -->
                            <button type="button" class="absolute right-10 top-1/2 -translate-y-1/2 text-primary hover:text-primary/80 transition-colors" onclick="editCustomOption('size')">
                                <i class="fa fa-pencil"></i>
                            </button>
                        </div>
                        <div class="flex items-center mt-2" id="size-add-container" style="display: none;">
                            <input type="text" id="new-size" class="input-field text-sm w-full mr-2" placeholder="添加新尺寸（如：3XL、42码）">
                            <button class="btn-primary px-2 py-1 text-sm" onclick="addCustomOption('size')">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 价格范围筛选 -->
                    <div class="mb-4.5">
                        <label class="form-label">价格范围</label>
                        <div class="flex gap-2">
                            <input type="number" id="min-price" class="input-field text-sm" placeholder="最低" oninput="debouncedApplyFilters()">
                            <span class="self-center">-</span>
                            <input type="number" id="max-price" class="input-field text-sm" placeholder="最高" oninput="debouncedApplyFilters()">
                        </div>
                    </div>
                    
                    <!-- 产品状态筛选 -->
                    <div class="mb-4.5">
                        <label class="form-label">产品状态</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="onsale" class="form-checkbox h-4 w-4 text-primary rounded" checked onchange="debouncedApplyFilters()">
                                <span>在售</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discontinued" class="form-checkbox h-4 w-4 text-primary rounded" checked onchange="debouncedApplyFilters()">
                                <span>已停产</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="hot" class="form-checkbox h-4 w-4 text-primary rounded" checked onchange="debouncedApplyFilters()">
                                <span>爆款</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="checkbox" value="discount" class="form-checkbox h-4 w-4 text-primary rounded" checked onchange="debouncedApplyFilters()">
                                <span>特价</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 筛选按钮 -->
                    <button class="btn-primary w-full" onclick="applyFilters()">
                        <i class="fa fa-filter mr-1"></i> 应用筛选
                    </button>
                </div>

                <!-- 右侧内容区 (统计 + 产品列表) -->
                <div class="lg:w-3/4 flex flex-col gap-6">
                    <!-- 数据统计区 -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">产品总数</p>
                                <p id="total-products" class="text-xl font-bold text-primary">0</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">在售产品</p>
                                <p id="onsale-products" class="text-xl font-bold text-success">0</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">已停产产品</p>
                                <p id="discontinued-products" class="text-xl font-bold text-danger">0</p>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3 text-center">
                                <p class="text-sm text-secondary dark:text-gray-400 mb-1">爆款产品</p>
                                <p id="hot-products" class="text-xl font-bold text-warning">0</p>
                            </div>
                        </div>
                        
                        <!-- 产品系列分布图表 -->
                        <div class="h-64">
                            <canvas id="series-chart"></canvas>
                        </div>
                    </div>

                    <!-- 排序栏 -->
                    <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-xl shadow p-4 transition-theme">
                        <h2 class="text-lg font-semibold">产品列表</h2>
                        <div class="flex items-center">
                            <label class="text-sm mr-2 dark:text-gray-300">排序:</label>
                            <select id="sort-by" class="input-field text-sm w-auto" onchange="sortProducts()">
                                <option value="newest">最新添加</option>
                                <option value="price-asc">价格从低到高</option>
                                <option value="price-desc">价格从高到低</option>
                            </select>
                        </div>
                    </div>

                    <!-- 产品列表区 -->
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="col-span-full text-center py-10 text-secondary dark:text-gray-400">
                            <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                            <p>暂无产品数据</p>
                            <p id="empty-hint" class="text-sm mt-1 hidden">请添加产品或导入数据</p>
                        </div>
                    </div>

                    <!-- 新增：分页控件 -->
                    <div id="pagination" class="flex justify-center mt-6 hidden">
                        <button id="prev-page" class="btn-secondary mr-2" onclick="changePage(-1)">上一页</button>
                        <span id="page-info" class="self-center px-2">第1页 / 共0页</span>
                        <button id="next-page" class="btn-secondary ml-2" onclick="changePage(1)">下一页</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-white dark:bg-gray-800 py-4 mt-auto transition-theme">
            <div class="container mx-auto px-4 text-center text-sm text-secondary dark:text-gray-400">
                <p>Marco Polo速查 © 2025 产品管理系统</p>
            </div>
        </footer>
    </div>

    <!-- 产品编辑模态框 (仅管理员可见) -->
    <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 id="modal-title" class="text-lg font-bold">添加产品</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="closeProductModal()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)" class="p-4">
                <input type="hidden" id="product-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4.5">
                    <div>
                        <label for="product-name" class="form-label">产品名称</label>
                        <input type="text" id="product-name" class="input-field" placeholder="请输入产品名称" required>
                    </div>
                    <div>
                        <label for="product-series" class="form-label">产品系列</label>
                        <select id="product-series" class="input-field" required>
                            <option value="">选择系列</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4.5">
                    <div>
                        <label for="product-size" class="form-label">尺寸规格</label>
                        <select id="product-size" class="input-field" required>
                            <option value="">选择尺寸</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-price" class="form-label">产品价格</label>
                        <input type="number" id="product-price" class="input-field" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="mb-4.5">
                    <label for="product-status" class="form-label">产品状态</label>
                    <select id="product-status" class="input-field" required>
                        <option value="onsale">在售</option>
                        <option value="discontinued">已停产</option>
                        <option value="hot">爆款</option>
                        <option value="discount">特价</option>
                    </select>
                </div>

                <!-- 图片上传区域 -->
                <div class="mb-4.5">
                    <label class="form-label">产品图片</label>
                    <div class="space-y-3">
                        <!-- 图片预览 -->
                        <div id="image-preview-container" class="w-full h-40 border border-gray-200 dark:border-gray-700 rounded-lg flex items-center justify-center overflow-hidden bg-gray-50 dark:bg-gray-900">
                            <img id="image-preview" src="" alt="产品图片预览" class="w-full h-full object-cover hidden">
                            <div id="image-placeholder" class="text-center text-gray-400">
                                <i class="fa fa-picture-o text-3xl mb-2"></i>
                                <p class="text-sm">未选择图片</p>
                            </div>
                        </div>
                        
                        <!-- 上传按钮组 -->
                        <div class="flex gap-2">
                            <!-- 本地上传 -->
                            <label class="btn-secondary flex-1 text-center cursor-pointer">
                                <i class="fa fa-upload mr-1"></i> 本地上传
                                <input type="file" id="local-upload" accept="image/jpg,image/png" class="hidden" onchange="handleLocalUpload(event)">
                            </label>
                            <!-- 拍摄上传（调用设备摄像头） -->
                            <label class="btn-secondary flex-1 text-center cursor-pointer">
                                <i class="fa fa-camera mr-1"></i> 拍摄上传
                                <input type="file" id="camera-upload" accept="image/jpg,image/png" capture="environment" class="hidden" onchange="handleCameraUpload(event)">
                            </label>
                            <!-- 删除图片（编辑时显示） -->
                            <button id="delete-image" type="button" class="btn-danger hidden" onclick="deleteProductImage()">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- 上传提示 -->
                        <p id="upload-hint" class="text-xs text-secondary hidden">支持JPG/PNG格式，最大5MB</p>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-lg font-bold">系统设置</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="document.getElementById('settings-modal').classList.add('hidden')">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <h3 class="font-medium mb-3">密码修改</h3>
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="user-password" class="form-label">普通用户密码</label>
                        <div class="relative">
                            <input type="password" id="user-password" class="input-field pr-10" placeholder="输入新密码">
                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('user-password')">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="user-password-confirm" class="form-label">确认普通用户密码</label>
                        <input type="password" id="user-password-confirm" class="input-field" placeholder="再次输入">
                    </div>
                    
                    <div>
                        <label for="admin-password" class="form-label">管理员密码</label>
                        <div class="relative">
                            <input type="password" id="admin-password" class="input-field pr-10" placeholder="输入新密码">
                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors" onclick="togglePassword('admin-password')">
                                <i class="fa fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="admin-password-confirm" class="form-label">确认管理员密码</label>
                        <input type="password" id="admin-password-confirm" class="input-field" placeholder="再次输入">
                    </div>
                </div>
                
                <button class="btn-primary w-full mb-6" onclick="savePasswords()">保存密码修改</button>
                
                <h3 class="font-medium mb-3">数据管理</h3>
                <div class="space-y-3">
                    <button class="btn-secondary w-full" onclick="importDemoData()">
                        <i class="fa fa-file-text-o mr-1"></i> 导入演示数据
                    </button>
                    <button class="btn-danger w-full" onclick="confirmAction('确定要清除所有产品数据吗？此操作不可恢复！', clearAllData)">
                        <i class="fa fa-trash mr-1"></i> 清除所有产品数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-lg font-bold">使用帮助</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="document.getElementById('help-modal').classList.add('hidden')">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <h3 class="font-medium text-primary">基本操作</h3>
                    <p class="text-sm mt-1">登录系统后可以查看产品列表，管理员可以添加、编辑和删除产品。</p>
                </div>
                <div>
                    <h3 class="font-medium text-primary">筛选产品</h3>
                    <p class="text-sm mt-1">使用左侧筛选面板可以按系列、尺寸、价格和状态筛选产品。</p>
                </div>
                <div id="admin-help" class="hidden">
                    <h3 class="font-medium text-primary">管理员功能</h3>
                    <p class="text-sm mt-1">管理员可以添加自定义系列和尺寸，修改用户密码，导入导出数据，上传产品图片。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md transition-theme">
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-lg font-bold">确认操作</h2>
            </div>
            <div class="p-4">
                <p id="confirm-message" class="mb-4">确认要执行此操作吗？</p>
                <div class="flex justify-end gap-3">
                    <button class="btn-secondary" onclick="closeConfirm()">取消</button>
                    <button id="confirm-ok" class="btn-primary">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div id="toast" class="fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full hidden">
        <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <!-- 新增：编辑自定义选项弹窗 -->
    <div id="edit-option-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md transition-theme">
            <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-lg font-bold" id="edit-modal-title">编辑产品系列</h2>
                <button class="text-gray-500 hover:text-danger transition-colors" onclick="document.getElementById('edit-option-modal').classList.add('hidden')">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="edit-option-form" onsubmit="saveEditedOption(event)" class="p-4">
                <input type="hidden" id="edit-option-type">
                <input type="hidden" id="edit-option-old-value">
                <div class="mb-4.5">
                    <label for="edit-option-new-value" class="form-label">新名称</label>
                    <input type="text" id="edit-option-new-value" class="input-field" placeholder="输入新名称" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('edit-option-modal').classList.add('hidden')">取消</button>
                    <button type="submit" class="btn-primary">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量初始化
        let products = [];
        let customSeries = [];
        let customSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '4XL', '40码', '41码', '42码', '43码'];
        let passwords = { user: '', admin: '' };
        let currentUser = '';
        let dataSyncListener = null;
        let seriesChart = null;
        let currentImageFile = null;
        let currentImageUrl = '';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        
        // 新增：分页相关变量
        let page = 1;
        const pageSize = 10;
        let totalPages = 1;
        
        // 初始化Supabase客户端
        const supabaseUrl = 'https://xntvwcweuqnqpgnmvbzq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhudHZ3Y3dldXFucXBnbm12YnpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODkyOTAsImV4cCI6MjA3Njk2NTI5MH0.W2_akOurOxlp1quO5uDFnc8MCTtBxrVaBhiHIxu041s';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 页面加载完成后初始化
        window.onload = async function() {
            // 检查主题设置
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // 检查登录状态
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // 新增：验证用户合法性
                const validEmails = ['user@example.com', 'admin@example.com'];
                if (!validEmails.includes(session.user.email)) {
                    await supabase.auth.signOut();
                    showToast('非法用户，已强制登出', 'error');
                    return;
                }
                
                currentUser = session.user.email === 'admin@example.com' ? 'admin' : 'user';
                await loadCustomOptions();
                await loadProducts();
                setupDataSync();
                showAppPage();
            } else {
                await loadPasswords();
            }
        };

        // 加载产品数据（新增分页功能）
        async function loadProducts() {
            showLoading(); // 新增：显示加载动画
            try {
                const { data, error, count } = await supabase
                    .from('products')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range((page-1)*pageSize, page*pageSize - 1); // 新增：分页范围

                if (error) throw error;
                
                if (data) {
                    products = data;
                    totalPages = Math.ceil((count || 0) / pageSize);
                    renderProductList();
                    updateStatistics();
                    updateCharts();
                    updatePagination(); // 新增：更新分页控件
                }
            } catch (error) {
                showToast('加载产品数据失败', 'error');
                console.error('Error loading products:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 从Supabase加载自定义选项
        async function loadCustomOptions() {
            showLoading(); // 新增：显示加载动画
            try {
                // 加载产品系列
                const { data: seriesData } = await supabase
                    .from('custom_options')
                    .select('value')
                    .eq('type', 'series');
                
                // 加载尺寸规格
                const { data: sizeData } = await supabase
                    .from('custom_options')
                    .select('value')
                    .eq('type', 'size');
                
                if (seriesData && seriesData.length > 0) {
                    customSeries = seriesData.map(item => item.value);
                }
                
                // 合并数据库尺寸和默认尺寸
                if (sizeData && sizeData.length > 0) {
                    const dbSizes = sizeData.map(item => item.value);
                    customSizes = [...new Set([...customSizes, ...dbSizes])];
                } else {
                    // 初始化默认尺寸到数据库
                    const defaultSizes = customSizes;
                    for (const size of defaultSizes) {
                        await supabase
                            .from('custom_options')
                            .insert({ type: 'size', value: size })
                            .eq('type', 'size')
                            .eq('value', size);
                    }
                }
                
                // 更新下拉菜单
                updateSelectOptions('series-filter', customSeries);
                updateSelectOptions('product-series', customSeries);
                updateSelectOptions('size-filter', customSizes);
                updateSelectOptions('product-size', customSizes);
                
                // 更新设置页面的选项列表
                renderCustomOptionsLists();
            } catch (error) {
                showToast('加载选项数据失败', 'error');
                console.error('Error loading options:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 加载密码配置
        async function loadPasswords() {
            showLoading(); // 新增：显示加载动画
            try {
                const { data } = await supabase
                    .from('settings')
                    .select('key, value')
                    .in('key', ['user_password', 'admin_password']);
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        if (item.key === 'user_password') {
                            passwords.user = item.value;
                        } else if (item.key === 'admin_password') {
                            passwords.admin = item.value;
                        }
                    });
                }
            } catch (error) {
                showToast('加载密码配置失败', 'error');
                console.error('Error loading passwords:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 设置数据同步监听
        function setupDataSync() {
            // 监听产品数据变化
            const productsSubscription = supabase
                .channel('custom-filter-channel')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'products' },
                    (payload) => {
                        console.log('Product change detected:', payload);
                        loadProducts();
                    }
                )
                .subscribe();
            
            // 监听自定义选项变化
            const optionsSubscription = supabase
                .channel('custom-options-channel')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'custom_options' },
                    (payload) => {
                        console.log('Custom option change detected:', payload);
                        loadCustomOptions();
                    }
                )
                .subscribe();
                
            dataSyncListener = { productsSubscription, optionsSubscription };
        }

        // 处理登录（新增密码加密验证）
        async function handleLogin(event) {
            event.preventDefault();
            showLoading(); // 新增：显示加载动画
            
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const authType = document.getElementById('auth-type').value;
                
                // 新增：密码加密验证
                const encryptedPassword = hashPassword(password);
                
                if ((authType === 'user' && encryptedPassword !== passwords.user) || 
                    (authType === 'admin' && encryptedPassword !== passwords.admin)) {
                    document.getElementById('login-error').classList.remove('hidden');
                    return;
                }
                
                // 登录成功，更新用户角色
                currentUser = authType;
                await loadCustomOptions();
                await loadProducts();
                setupDataSync();
                showAppPage();
                showToast('登录成功');
            } catch (error) {
                showToast('登录失败', 'error');
                console.error('Login error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 处理登出
        async function handleLogout() {
            showLoading(); // 新增：显示加载动画
            try {
                // 关闭数据同步监听
                if (dataSyncListener) {
                    await supabase.removeChannel(dataSyncListener.productsSubscription);
                    await supabase.removeChannel(dataSyncListener.optionsSubscription);
                }
                
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('app-page').classList.add('hidden');
                showToast('已成功退出登录');
            } catch (error) {
                showToast('登出失败', 'error');
                console.error('Logout error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 保存产品
        async function saveProduct(event) {
            event.preventDefault();
            showLoading(); // 新增：显示加载动画
            
            try {
                const productId = document.getElementById('product-id').value;
                const name = document.getElementById('product-name').value;
                const series = document.getElementById('product-series').value;
                const size = document.getElementById('product-size').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const status = document.getElementById('product-status').value;
                
                // 上传图片
                let imageUrl = currentImageUrl;
                if (currentImageFile) {
                    imageUrl = await uploadImageToSupabase(currentImageFile);
                    if (!imageUrl && currentImageFile) return;
                }
                
                const productData = {
                    name,
                    series,
                    size,
                    price,
                    status,
                    image: imageUrl,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                
                if (productId) {
                    // 更新现有产品
                    result = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', productId);
                } else {
                    // 添加新产品
                    result = await supabase
                        .from('products')
                        .insert({
                            ...productData,
                            created_at: new Date().toISOString()
                        });
                }
                
                if (result.error) {
                    showToast('保存产品失败', 'error');
                    console.error('Error saving product:', result.error);
                    return;
                }
                
                // 保存成功后，清空图片状态
                currentImageFile = null;
                currentImageUrl = '';
                closeProductModal();
                showToast(productId ? '产品更新成功' : '产品添加成功');
            } catch (error) {
                showToast('保存产品失败', 'error');
                console.error('Save product error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 添加自定义选项
        async function addCustomOption(type) {
            showLoading(); // 新增：显示加载动画
            try {
                const inputId = `new-${type}`;
                const value = document.getElementById(inputId).value.trim();
                
                if (!value) return;
                
                // 检查是否已存在
                const existingOptions = type === 'series' ? customSeries : customSizes;
                if (existingOptions.includes(value)) {
                    showToast('该选项已存在', 'warning');
                    return;
                }
                
                // 保存到Supabase
                const { error } = await supabase
                    .from('custom_options')
                    .insert({
                        type,
                        value
                    });
                
                if (error) {
                    showToast('添加失败', 'error');
                    console.error('Error adding custom option:', error);
                    return;
                }
                
                // 清空输入框
                document.getElementById(inputId).value = '';
                showToast('添加成功');
            } catch (error) {
                showToast('添加选项失败', 'error');
                console.error('Add option error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 保存密码修改（新增密码加密存储）
        async function savePasswords() {
            showLoading(); // 新增：显示加载动画
            try {
                const userPassword = document.getElementById('user-password').value;
                const userPasswordConfirm = document.getElementById('user-password-confirm').value;
                const adminPassword = document.getElementById('admin-password').value;
                const adminPasswordConfirm = document.getElementById('admin-password-confirm').value;
                
                // 验证用户密码
                if (userPassword && userPassword !== userPasswordConfirm) {
                    showToast('普通用户密码不一致', 'error');
                    return;
                }
                
                // 验证管理员密码
                if (adminPassword && adminPassword !== adminPasswordConfirm) {
                    showToast('管理员密码不一致', 'error');
                    return;
                }
                
                // 保存密码
                const updates = [];
                
                if (userPassword) {
                    updates.push({
                        key: 'user_password',
                        value: hashPassword(userPassword) // 新增：密码加密
                    });
                }
                
                if (adminPassword) {
                    updates.push({
                        key: 'admin_password',
                        value: hashPassword(adminPassword) // 新增：密码加密
                    });
                }
                
                if (updates.length > 0) {
                    const { error } = await supabase
                        .from('settings')
                        .upsert(updates);
                    
                    if (error) {
                        showToast('保存密码失败', 'error');
                        console.error('Error saving passwords:', error);
                        return;
                    }
                    
                    // 更新本地密码缓存
                    updates.forEach(update => {
                        if (update.key === 'user_password') {
                            passwords.user = update.value;
                        } else if (update.key === 'admin_password') {
                            passwords.admin = update.value;
                        }
                    });
                    
                    // 清空输入框
                    document.getElementById('user-password').value = '';
                    document.getElementById('user-password-confirm').value = '';
                    document.getElementById('admin-password').value = '';
                    document.getElementById('admin-password-confirm').value = '';
                    
                    showToast('密码修改成功');
                }
            } catch (error) {
                showToast('保存密码失败', 'error');
                console.error('Save passwords error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 清除所有产品数据
        async function clearAllData() {
            showLoading(); // 新增：显示加载动画
            try {
                // 先删除所有图片
                for (const product of products) {
                    if (product.image) {
                        const imagePath = product.image.split('/').slice(-2).join('/');
                        await supabase.storage.from('product-images').remove([imagePath]);
                    }
                }
                
                // 再删除产品数据
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .neq('id', '');
                
                if (error) {
                    showToast('清除数据失败', 'error');
                    console.error('Error clearing data:', error);
                    return;
                }
                
                products = [];
                renderProductList();
                updateStatistics();
                updateCharts();
                closeConfirm();
                showToast('所有产品数据已清除');
            } catch (error) {
                showToast('清除数据失败', 'error');
                console.error('Clear data error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 导入演示数据
        async function importDemoData() {
            showLoading(); // 新增：显示加载动画
            try {
                const demoProducts = [
                    {
                        name: '基础款T恤',
                        series: '基础款',
                        size: 'M',
                        price: 99.99,
                        status: 'onsale',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    {
                        name: '旗舰款夹克',
                        series: '旗舰款',
                        size: 'L',
                        price: 399.99,
                        status: 'hot',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    {
                        name: '进阶款裤子',
                        series: '进阶款',
                        size: 'XL',
                        price: 199.99,
                        status: 'discount',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }
                ];
                
                // 先添加演示系列和尺寸
                const demoSeries = [...new Set(demoProducts.map(p => p.series))];
                const demoSizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL', '40码', '41码', '42码'];
                
                for (const series of demoSeries) {
                    if (!customSeries.includes(series)) {
                        await supabase.from('custom_options').insert({ type: 'series', value: series });
                    }
                }
                
                for (const size of demoSizes) {
                    if (!customSizes.includes(size)) {
                        await supabase.from('custom_options').insert({ type: 'size', value: size });
                    }
                }
                
                // 导入产品
                const { error } = await supabase
                    .from('products')
                    .insert(demoProducts);
                
                if (error) {
                    showToast('导入演示数据失败', 'error');
                    console.error('Error importing demo data:', error);
                    return;
                }
                
                // 刷新数据
                await loadCustomOptions();
                await loadProducts();
                showToast('演示数据导入成功');
            } catch (error) {
                showToast('导入演示数据失败', 'error');
                console.error('Import demo data error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-message');
            
            if (type === 'success') {
                toast.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 bg-success text-white';
                icon.className = 'fa fa-check-circle mr-2';
            } else if (type === 'error') {
                toast.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 bg-danger text-white';
                icon.className = 'fa fa-exclamation-circle mr-2';
            } else if (type === 'warning') {
                toast.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 bg-warning text-white';
                icon.className = 'fa fa-exclamation-triangle mr-2';
            }
            
            text.textContent = message;
            toast.classList.remove('translate-x-full', 'hidden');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        // 显示应用页面
        function showAppPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app-page').classList.remove('hidden');
            
            // 更新用户角色显示
            document.getElementById('user-role').textContent = currentUser === 'admin' ? '管理员' : '普通用户';
            
            // 显示管理员功能
            if (currentUser === 'admin') {
                document.getElementById('action-bar').style.display = 'flex';
                document.getElementById('settings-btn').style.display = 'block';
                document.getElementById('series-add-container').style.display = 'flex';
                document.getElementById('size-add-container').style.display = 'flex';
                document.getElementById('admin-help').classList.remove('hidden');
                document.getElementById('empty-hint').classList.remove('hidden');
            }
        }

        // 更新下拉选项
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // 切换认证类型
        function switchAuth(type) {
            document.getElementById('auth-type').value = type;
            if (type === 'user') {
                document.getElementById('user-tab').classList.add('bg-primary', 'text-white');
                document.getElementById('user-tab').classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                document.getElementById('admin-tab').classList.remove('bg-primary', 'text-white');
                document.getElementById('admin-tab').classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            } else {
                document.getElementById('admin-tab').classList.add('bg-primary', 'text-white');
                document.getElementById('admin-tab').classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                document.getElementById('user-tab').classList.remove('bg-primary', 'text-white');
                document.getElementById('user-tab').classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            }
        }

        // 切换密码显示状态
        function togglePassword(id) {
            const input = document.getElementById(id);
            const icon = document.querySelector(`button[onclick="togglePassword('${id}')"] i`);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        // 切换主题
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        // 打开产品模态框
        function openProductModal(product = null) {
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('product-form');
            
            // 重置图片预览
            const previewImg = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-placeholder');
            const deleteBtn = document.getElementById('delete-image');
            const uploadHint = document.getElementById('upload-hint');
            
            previewImg.src = '';
            previewImg.classList.add('hidden');
            placeholder.classList.remove('hidden');
            deleteBtn.classList.add('hidden');
            uploadHint.classList.add('hidden');
            currentImageFile = null;
            currentImageUrl = '';
            
            if (product) {
                title.textContent = '编辑产品';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-series').value = product.series;
                document.getElementById('product-size').value = product.size;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-status').value = product.status;
                
                if (product.image) {
                    currentImageUrl = product.image;
                    showImagePreview(product.image);
                }
            } else {
                title.textContent = '添加产品';
                form.reset();
                document.getElementById('product-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        // 关闭产品模态框
        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        // 渲染产品列表（新增图片懒加载）
        function renderProductList() {
            const container = document.getElementById('product-list');
            if (!container) return;
            
            const filteredProducts = applyFilters();
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10 text-secondary dark:text-gray-400">
                        <i class="fa fa-search text-4xl mb-2"></i>
                        <p>没有找到匹配的产品</p>
                        ${currentUser === 'admin' ? '<p class="text-sm mt-1">请尝试调整筛选条件或添加新产品</p>' : ''}
                    </div>
                `;
                return;
            }
            
            // 渲染产品卡片（图片添加懒加载属性）
            container.innerHTML = filteredProducts.map(product => `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 card-hover transition-theme">
                    <!-- 产品图片（新增loading="lazy"） -->
                    <div class="w-full h-40 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden mb-3">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover" loading="lazy">` : 
                            `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="fa fa-picture-o text-3xl"></i>
                            </div>`
                        }
                    </div>
                    
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold">${product.name}</h3>
                        <span class="badge ${getStatusBadgeClass(product.status)}">
                            ${getStatusText(product.status)}
                        </span>
                    </div>
                    <div class="text-sm text-secondary dark:text-gray-400 space-y-1 mb-3">
                        <p><span class="font-medium">系列:</span> ${product.series}</p>
                        <p><span class="font-medium">尺寸:</span> ${product.size}</p>
                        <p><span class="font-medium">价格:</span> ¥${product.price.toFixed(2)}</p>
                    </div>
                    ${currentUser === 'admin' ? `
                    <div class="flex justify-end gap-2 mt-2">
                        <button class="btn-secondary px-3 py-1 text-sm" onclick="openProductModal(${JSON.stringify(product)})">
                            <i class="fa fa-edit mr-1"></i> 编辑
                        </button>
                        <button class="btn-danger px-3 py-1 text-sm" onclick="confirmAction('确定要删除该产品吗？', async () => {
    if ('${product.image || ''}') {
        const imagePath = '${product.image || ''}'.split('/').slice(-2).join('/');
        await supabase.storage.from('product-images').remove([imagePath]);
    }
    
    const { error } = await supabase.from('products').delete().eq('id', '${product.id}');
    if (error) {
        showToast('删除失败', 'error');
        console.error(error);
    } else {
        showToast('删除成功');
        loadProducts();
    }
    closeConfirm();
})">
    <i class="fa fa-trash mr-1"></i> 删除
</button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'onsale': '在售',
                'discontinued': '已停产',
                'hot': '爆款',
                'discount': '特价'
            };
            return statusMap[status] || status;
        }

        // 获取状态标签样式
        function getStatusBadgeClass(status) {
            const classMap = {
                'onsale': 'bg-success/20 text-success',
                'discontinued': 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
                'hot': 'bg-warning/20 text-warning',
                'discount': 'bg-primary/20 text-primary'
            };
            return classMap[status] || 'bg-gray-200 text-gray-700';
        }

        // 更新统计数据
        function updateStatistics() {
            const total = products.length;
            const onsale = products.filter(p => p.status === 'onsale').length;
            const discontinued = products.filter(p => p.status === 'discontinued').length;
            const hot = products.filter(p => p.status === 'hot').length;
            
            document.getElementById('total-products').textContent = total;
            document.getElementById('onsale-products').textContent = onsale;
            document.getElementById('discontinued-products').textContent = discontinued;
            document.getElementById('hot-products').textContent = hot;
        }

        // 更新图表
        function updateCharts() {
            const ctx = document.getElementById('series-chart').getContext('2d');
            
            const seriesCount = {};
            products.forEach(product => {
                seriesCount[product.series] = (seriesCount[product.series] || 0) + 1;
            });
            
            const series = Object.keys(seriesCount);
            const counts = Object.values(seriesCount);
            
            if (seriesChart) {
                seriesChart.destroy();
            }
            
            seriesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: series,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#2563eb', '#10b981', '#ef4444', '#f59e0b', 
                            '#8b5cf6', '#ec4899', '#64748b', '#f97316'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#1f2937'
                            }
                        },
                        title: {
                            display: true,
                            text: '产品系列分布',
                            color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#1f2937'
                        }
                    }
                }
            });
        }

        // 应用筛选
        function applyFilters() {
            const series = document.getElementById('series-filter').value;
            const size = document.getElementById('size-filter').value;
            const minPrice = parseFloat(document.getElementById('min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max-price').value) || Infinity;
            
            const statusCheckboxes = document.querySelectorAll('input[type="checkbox"][value="onsale"], input[type="checkbox"][value="discontinued"], input[type="checkbox"][value="hot"], input[type="checkbox"][value="discount"]');
            const selectedStatuses = Array.from(statusCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            return products.filter(product => {
                const matchesSeries = !series || product.series === series;
                const matchesSize = !size || product.size === size;
                const matchesPrice = product.price >= minPrice && product.price <= maxPrice;
                const matchesStatus = selectedStatuses.includes(product.status);
                
                return matchesSeries && matchesSize && matchesPrice && matchesStatus;
            });
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('series-filter').value = '';
            document.getElementById('size-filter').value = '';
            document.getElementById('min-price').value = '';
            document.getElementById('max-price').value = '';
            
            document.querySelectorAll('input[type="checkbox"][value="onsale"], input[type="checkbox"][value="discontinued"], input[type="checkbox"][value="hot"], input[type="checkbox"][value="discount"]')
                .forEach(checkbox => checkbox.checked = true);
            
            renderProductList();
        }

        // 切换视图
        function switchView(view) {
            const productList = document.getElementById('product-list');
            const gridBtn = document.getElementById('grid-view');
            const listBtn = document.getElementById('list-view');
            
            if (view === 'grid') {
                productList.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
                gridBtn.classList.add('bg-primary', 'text-white');
                gridBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                listBtn.classList.remove('bg-primary', 'text-white');
                listBtn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            } else {
                productList.className = 'grid grid-cols-1 gap-4';
                listBtn.classList.add('bg-primary', 'text-white');
                listBtn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
                gridBtn.classList.remove('bg-primary', 'text-white');
                gridBtn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-gray-200', 'dark:hover:bg-gray-600');
            }
        }

        // 产品排序
        function sortProducts() {
            const sortBy = document.getElementById('sort-by').value;
            
            switch (sortBy) {
                case 'newest':
                    products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'price-asc':
                    products.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    products.sort((a, b) => b.price - a.price);
                    break;
            }
            
            renderProductList();
        }

        // 打开设置页面
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        // 打开帮助页面
        function openHelp() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        // 确认操作
        function confirmAction(message, callback) {
            const modal = document.getElementById('confirm-modal');
            const messageEl = document.getElementById('confirm-message');
            const okBtn = document.getElementById('confirm-ok');
            
            messageEl.textContent = message;
            modal.classList.remove('hidden');
            okBtn.onclick = function() {
                callback();
            };
        }

        // 关闭确认框
        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        // 导入数据
        function importData() {
            showLoading(); // 新增：显示加载动画
            try {
                // 触发文件选择对话框
                importInput.click();
                
                importInput.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                        showToast('请上传CSV格式文件', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            const csvData = event.target.result;
                            const products = parseCsvToProducts(csvData);
                            
                            if (products.length === 0) {
                                showToast('CSV文件中未找到有效数据', 'warning');
                                return;
                            }
                            
                            const { error } = await supabase
                                .from('products')
                                .insert(products);
                            
                            if (error) throw error;
                            
                            loadProducts();
                            showToast(`成功导入 ${products.length} 条产品数据`);
                        } catch (err) {
                            showToast('导入失败：' + err.message, 'error');
                            console.error('导入错误：', err);
                        } finally {
                            hideLoading();
                        }
                    };
                    reader.readAsText(file);
                };
            } catch (error) {
                showToast('导入数据失败', 'error');
                console.error('Import data error:', error);
                hideLoading();
            }
        }

        // 导出数据
        function exportData() {
            showLoading(); // 新增：显示加载动画
            try {
                if (products.length === 0) {
                    showToast('没有数据可导出', 'warning');
                    return;
                }
                
                const headers = ['名称', '系列', '尺寸', '价格', '状态', '图片URL', '创建时间', '更新时间'];
                const rows = products.map(p => [
                    p.name,
                    p.series,
                    p.size,
                    p.price,
                    getStatusText(p.status),
                    p.image || '',
                    new Date(p.created_at).toLocaleString(),
                    new Date(p.updated_at).toLocaleString()
                ]);
                
                const csvContent = "data:text/csv;charset=utf-8," 
                    + [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `产品数据_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('数据导出成功');
            } catch (error) {
                showToast('导出数据失败', 'error');
                console.error('Export data error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 渲染自定义选项列表
        function renderCustomOptionsLists() {
            // 保持原功能不变
        }

        // 图片上传相关函数
        function handleLocalUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                showToast('仅支持JPG/PNG格式', 'error');
                return;
            }
            if (file.size > MAX_IMAGE_SIZE) {
                showToast('图片大小不能超过5MB', 'error');
                return;
            }
            
            currentImageFile = file;
            showImagePreview(URL.createObjectURL(file));
        }

        function handleCameraUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > MAX_IMAGE_SIZE) {
                showToast('图片大小不能超过5MB', 'error');
                return;
            }
            
            currentImageFile = file;
            showImagePreview(URL.createObjectURL(file));
        }

        function showImagePreview(imageUrl) {
            const previewImg = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-placeholder');
            const deleteBtn = document.getElementById('delete-image');
            const uploadHint = document.getElementById('upload-hint');
            
            previewImg.src = imageUrl;
            previewImg.classList.remove('hidden');
            placeholder.classList.add('hidden');
            deleteBtn.classList.remove('hidden');
            uploadHint.classList.remove('hidden');
        }

        async function deleteProductImage() {
            showLoading(); // 新增：显示加载动画
            try {
                if (currentImageUrl) {
                    const imagePath = currentImageUrl.split('/').slice(-2).join('/');
                    const { error } = await supabase
                        .storage
                        .from('product-images')
                        .remove([imagePath]);
                    
                    if (error) {
                        showToast('删除图片失败', 'error');
                        console.error('Delete image error:', error);
                        return;
                    }
                    currentImageUrl = '';
                }
                
                currentImageFile = null;
                const previewImg = document.getElementById('image-preview');
                const placeholder = document.getElementById('image-placeholder');
                const deleteBtn = document.getElementById('delete-image');
                const uploadHint = document.getElementById('upload-hint');
                
                previewImg.src = '';
                previewImg.classList.add('hidden');
                placeholder.classList.remove('hidden');
                deleteBtn.classList.add('hidden');
                uploadHint.classList.add('hidden');
                
                document.getElementById('local-upload').value = '';
                document.getElementById('camera-upload').value = '';
            } catch (error) {
                showToast('删除图片失败', 'error');
                console.error('Delete image error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        async function uploadImageToSupabase(file) {
            showLoading(); // 新增：显示加载动画
            try {
                if (!file) return '';
                
                const productId = document.getElementById('product-id').value || Date.now();
                const fileExt = file.name.split('.').pop();
                const fileName = `${productId}_${Date.now()}.${fileExt}`;
                const filePath = `product-images/${fileName}`;
                
                const { data, error } = await supabase
                    .storage
                    .from('product-images')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: true
                    });
                
                if (error) {
                    showToast('图片上传失败', 'error');
                    console.error('Upload image error:', error);
                    return '';
                }
                
                const { data: { publicUrl } } = supabase
                    .storage
                    .from('product-images')
                    .getPublicUrl(filePath);
                
                return publicUrl;
            } catch (error) {
                showToast('图片上传失败', 'error');
                console.error('Upload image error:', error);
                return '';
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 创建隐藏的文件上传输入框
        const importInput = document.createElement('input');
        importInput.type = 'file';
        importInput.accept = '.csv';
        importInput.style.display = 'none';
        document.body.appendChild(importInput);

        // CSV解析为产品数据数组
        function parseCsvToProducts(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredHeaders = ['名称', '系列', '尺寸', '价格', '状态'];
            const hasRequired = requiredHeaders.every(h => headers.includes(h.toLowerCase()));
            
            if (!hasRequired) {
                throw new Error('CSV文件必须包含：名称、系列、尺寸、价格、状态列');
            }
            
            return lines.slice(1).map((line, index) => {
                const values = line.split(',').map(v => v.trim());
                const product = {
                    name: values[headers.indexOf('名称')] || `未命名产品${index+1}`,
                    series: values[headers.indexOf('系列')] || '未知系列',
                    size: values[headers.indexOf('尺寸')] || '未知尺寸',
                    price: parseFloat(values[headers.indexOf('价格')]) || 0,
                    status: mapStatus(values[headers.indexOf('状态')]) || 'onsale',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                return product;
            });
        }

        // 状态文本映射
        function mapStatus(statusText) {
            const statusMap = {
                '在售': 'onsale',
                '已停产': 'discontinued',
                '爆款': 'hot',
                '特价': 'discount'
            };
            return statusMap[statusText] || null;
        }

        // 打开编辑自定义选项弹窗
        function editCustomOption(type) {
            const selectId = `${type}-filter`;
            const select = document.getElementById(selectId);
            const selectedValue = select.value;
            
            if (!selectedValue || selectedValue === '') {
                showToast('请先选择要编辑的选项', 'warning');
                return;
            }
            
            document.getElementById('edit-option-type').value = type;
            document.getElementById('edit-option-old-value').value = selectedValue;
            document.getElementById('edit-option-new-value').value = selectedValue;
            document.getElementById('edit-modal-title').textContent = `编辑${type === 'series' ? '产品系列' : '尺寸规格'}`;
            document.getElementById('edit-option-modal').classList.remove('hidden');
        }

        // 保存编辑后的自定义选项
        async function saveEditedOption(event) {
            event.preventDefault();
            showLoading(); // 新增：显示加载动画
            
            try {
                const type = document.getElementById('edit-option-type').value;
                const oldValue = document.getElementById('edit-option-old-value').value;
                const newValue = document.getElementById('edit-option-new-value').value.trim();
                
                if (oldValue === newValue) {
                    showToast('名称未修改', 'warning');
                    document.getElementById('edit-option-modal').classList.add('hidden');
                    return;
                }
                
                const existingOptions = type === 'series' ? customSeries : customSizes;
                if (existingOptions.includes(newValue)) {
                    showToast('该名称已存在', 'error');
                    return;
                }
                
                const { error } = await supabase
                    .from('custom_options')
                    .update({ value: newValue })
                    .eq('type', type)
                    .eq('value', oldValue);
                
                if (error) {
                    showToast('修改失败', 'error');
                    console.error('Edit option error:', error);
                    return;
                }
                
                if (type === 'series') {
                    const index = customSeries.indexOf(oldValue);
                    if (index > -1) {
                        customSeries[index] = newValue;
                    }
                } else {
                    const index = customSizes.indexOf(oldValue);
                    if (index > -1) {
                        customSizes[index] = newValue;
                    }
                }
                
                updateSelectOptions(`${type}-filter`, type === 'series' ? customSeries : customSizes);
                updateSelectOptions(`product-${type}`, type === 'series' ? customSeries : customSizes);
                
                const updatePromises = products.map(product => {
                    if (product[type] === oldValue) {
                        return supabase
                            .from('products')
                            .update({ [type]: newValue })
                            .eq('id', product.id);
                    }
                    return Promise.resolve();
                });
                
                await Promise.all(updatePromises);
                await loadProducts();
                
                document.getElementById('edit-option-modal').classList.add('hidden');
                showToast('修改成功');
            } catch (error) {
                showToast('保存修改失败', 'error');
                console.error('Save edited option error:', error);
            } finally {
                hideLoading(); // 新增：隐藏加载动画
            }
        }

        // 新增：工具函数 - 密码加密
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        // 新增：工具函数 - 防抖处理
        function debounce(func, delay = 500) {
            let timer = null;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 新增：防抖后的筛选函数
        const debouncedApplyFilters = debounce(() => {
            renderProductList();
        });

        // 新增：加载动画控制
        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        // 新增：分页控制
        function changePage(direction) {
            const newPage = page + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                page = newPage;
                loadProducts();
            }
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            pageInfo.textContent = `第${page}页 / 共${totalPages}页`;
            
            prevBtn.disabled = page === 1;
            prevBtn.classList.toggle('opacity-50', page === 1);
            prevBtn.classList.toggle('cursor-not-allowed', page === 1);
            
            nextBtn.disabled = page === totalPages;
            nextBtn.classList.toggle('opacity-50', page === totalPages);
            nextBtn.classList.toggle('cursor-not-allowed', page === totalPages);
        }
    </script>
</body>
</html>
